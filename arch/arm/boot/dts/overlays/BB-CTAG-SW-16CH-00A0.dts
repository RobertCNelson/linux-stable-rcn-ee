/*
 * Copyright (C) 2020 Deepak Khatri <deepaklorkhatri7@gmail.com>
 * Device Tree Overlay for CTAG face2|4 multichannel soundcard - 8 audio channels
 *
 * Based on the BB-CTAG-SW-16CH-00A0.dts for kernel <4.14 written by
 * Copyright (C) Henrik Langer <henni19790@googlemail.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 3 as
 * published by the Free Software Foundation.
 */
/dts-v1/;
/plugin/;

/*
 * Helper to show loaded overlays under: /proc/device-tree/chosen/overlays/
 */
&{/chosen} {
	overlays {
		BB-CTAG-SW-16CH-00A0 = __TIMESTAMP__;
	};
};

/*
 * Update the default pinmux of the pins.
 * See these files for the phandles (&P9_* & &P8_*)
 * https://github.com/lorforlinux/BeagleBoard-DeviceTrees/blob/compatibility/src/arm/am335x-bone-common-univ.dtsi
 * https://github.com/lorforlinux/BeagleBoard-DeviceTrees/blob/compatibility/src/arm/am572x-bone-common-univ.dtsi
 */
&ocp {
	P9_30_pinmux { pinctrl-0 = <&P9_30_mcasp_pin>; }; /* mcasp axr - audio in */
	P9_28_pinmux { pinctrl-0 = <&P9_28_mcasp_pin>; }; /* mcasp axr - audio out */
	P9_31_pinmux { pinctrl-0 = <&P9_31_mcasp_pin>; }; /* mcasp ahclkx - transmit bitclock */
	P9_29_pinmux { pinctrl-0 = <&P9_29_mcasp_pin>; }; /* mcasp fsx - transmit frameclock */
	P9_12_pinmux { pinctrl-0 = <&P9_12_mcasp_pin>; }; /* mcasp aclkr - receive bitclock */
	P9_27_pinmux { pinctrl-0 = <&P9_27_mcasp_pin>; }; /* mcasp fsr - receive frameclock */
	P9_25_pinmux { pinctrl-0 = <&P9_25_mcasp_pin>; }; /* mcasp ahclkx - masterclock */
	P8_32_pinmux { pinctrl-0 = <&P8_32_gpio_pu_pin>; }; /* spi_sclk */
	P8_33_pinmux { pinctrl-0 = <&P8_33_gpio_pu_pin>; }; /* spi_mosi */
	P8_14_pinmux { pinctrl-0 = <&P8_14_gpio_pu_pin>; }; /* spi_miso */
	P8_17_pinmux { pinctrl-0 = <&P8_17_gpio_pu_pin>; }; /* spi_cs0 */
	P8_31_pinmux { pinctrl-0 = <&P8_31_gpio_pu_pin>; }; /* spi_cs1 */
};

/*
 * See these files for the phandles (&bone_*) and other bone bus nodes
 * https://github.com/lorforlinux/BeagleBoard-DeviceTrees/blob/compatibility/src/arm/bbai-bone-buses.dtsi
 * https://github.com/lorforlinux/BeagleBoard-DeviceTrees/blob/compatibility/src/arm/bbb-bone-buses.dtsi
 */
&bone_mcasp_0 {
	status = "okay";
	op-mode = <0>;	/* MCASP_IIS_MODE */
	tdm-slots = <16>;
	num-serializer = <16>;
	serial-dir = <  /* 0: INACTIVE, 1: TX, 2: RX */
		2 0 1 0
		0 0 0 0
		0 0 0 0
		0 0 0 0
	>;
	tx-num-evt = <1>;
	rx-num-evt = <1>;
};

&ocp {
	sound {
		compatible = "ctag,face-2-4";
		model = "CTAG face-2-4 16CH";
		audio-codec = <&ad193x_master>;
		audio-codec-aux = <&ad193x_aux>;
		mcasp-controller = <&bone_mcasp_0>;
		audiocard-tdm-slots = <16>;
		codec-clock-rate = <24576000>;
		cpu-clock-rate = <24576000>;
		audio-codec-bit-delay-dac = <1>; //currently only supports 1 or 0 bit delay
		audio-codec-bit-delay-adc = <1>;
		audio-codec-aux-bit-delay-dac = <1>;
		audio-codec-aux-bit-delay-adc = <1>;
		mcasp-controller-bit-delay-tx = <1>;
		mcasp-controller-bit-delay-rx = <1>;
		bb-device = <0>; //BBB/BBG
		audio-routing =
			"Line Out",             "DAC1OUT",
			"Line Out",             "DAC2OUT",
			"Line Out",             "DAC3OUT",
			"Line Out",             "DAC4OUT",
			//"Line Out",             "DAC5OUT",
			//"Line Out",             "DAC6OUT",
			//"Line Out",             "DAC7OUT",
			//"Line Out",             "DAC8OUT",
			"ADC1IN",               "Line In",
			"ADC2IN",               "Line In",
			"ADC3IN",               "Line In",
			"ADC4IN",               "Line In";
	};
};

&{/} {
	spi_gpio: spi_gpio {
		compatible = "spi-gpio";
		/* avoid dtc warnings */
		#address-cells = <1>;
		#size-cells = <0>;

		ad193x_master: ad193x@0{
			#address-cells = <1>;
			#size-cells = <0>;
			compatible = "analog,ad1938";
			reg = <0>; //corresponds to cs
			spi-max-frequency = <100000>;
		};

		ad193x_aux: ad193x@1{
			#address-cells = <1>;
			#size-cells = <0>;
			compatible = "analog,ad1938-dc";
			reg = <1>;
			spi-max-frequency = <100000>;
		};
	};
};